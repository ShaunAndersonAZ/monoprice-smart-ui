
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Monoprice Smart Control</title>
<style>
  :root { color-scheme: dark; }
  body { font-family: system-ui, sans-serif; margin:0; background:#0f172a; color:#e5e7eb; }
  header { padding:12px 16px; display:flex; gap:10px; justify-content:space-between; align-items:center; background:#111827; position:sticky; top:0; }
  .grid { display:grid; gap:12px; padding:16px; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
  .tile { background:#1f2937; border-radius:12px; padding:14px; box-shadow:0 2px 8px rgba(0,0,0,.3); border:1px solid transparent; transition: box-shadow .2s ease, border-color .2s ease, transform .1s ease; }
  .tile.active { border-color:#10b98155; box-shadow:0 0 0 2px #10b98133, 0 4px 16px rgba(16,185,129,.25); }
  .row { display:flex; justify-content:space-between; align-items:center; gap:8px; }
  .vol { width:100%; }
  button, select, input[type="text"] { background:#374151; color:#e5e7eb; border:0; padding:8px 10px; border-radius:8px; }
  .on { background:#10b981; color:#062e26; }
  .off { background:#ef4444; color:#3b0a0a; }
  .badge { display:inline-block; padding:2px 8px; border-radius:999px; font-size:.75rem; }
  .badge.on { background:#10b98122; color:#34d399; border:1px solid #10b98155; }
  .badge.off { background:#ef444422; color:#f87171; border:1px solid #ef444455; }
  .muted { color:#f59e0b; margin-left:8px; }
  .dnd   { color:#60a5fa; margin-left:8px; }
  .small { font-size:.85rem; opacity:.8; }
  .modal { position:fixed; inset:0; display:none; background:rgba(0,0,0,.6); align-items:center; justify-content:center; }
  .card { background:#111827; padding:16px; border-radius:12px; width:min(480px, 92vw); }
  label { display:block; margin-top:10px; }
</style>
</head>
<body>
<header>
  <strong>Monoprice Smart Control</strong>
  <div style="display:flex; gap:8px">
    <button onclick="openSources()">Sources</button>
    <span id="status" class="small">Ready</span>
  </div>
</header>

<main class="grid" id="grid"></main>

<!-- Zone Settings -->
<div class="modal" id="settings">
  <div class="card">
    <h3 id="s-title">Zone Settings</h3>
    <label>Zone name <input id="s-name" type="text" /></label>
    <label>Source
      <select id="s-source"></select>
    </label>
    <label>Bass (00–14) <input type="range" min="0" max="14" id="s-bass"/></label>
    <label>Treble (00–14) <input type="range" min="0" max="14" id="s-treble"/></label>
    <label>Balance (00–14) <input type="range" min="0" max="14" id="s-balance"/></label>
    <div class="row" style="margin-top:12px">
      <button id="s-save">Save</button>
      <button onclick="closeSettings()">Close</button>
    </div>
  </div>
</div>

<!-- Source Names -->
<div class="modal" id="sources">
  <div class="card">
    <h3>Source Names</h3>
    <div id="sources-list"></div>
    <div class="row" style="margin-top:12px">
      <button onclick="saveSources()">Save</button>
      <button onclick="closeSources()">Close</button>
    </div>
  </div>
</div>

<script>
const API = '/api';
const AUTO_REFRESH_MS = 2000; // set to 0 to disable auto refresh

let zones = [11,12,13,14,15,16];
let prefs = {};
let sources = [];
let currentZone = null;
let refreshTimer = null;

// --- helpers ---
async function getJSON(url) { return (await fetch(url)).json(); }
async function postJSON(url, body) {
  const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
  return res.json();
}
function srcName(id) {
  const s = sources.find(x => x.id === id);
  return s ? s.name : (id != null ? `Source ${id}` : '—');
}
function zoneDisplayName(z) {
  return (prefs[z]?.name) || `Zone ${z}`;
}

// --- UI builders (live state aware) ---
function tileHTML(zs) {
  const z = zs.zone;
  const name = zoneDisplayName(z);
  const powerOn = zs.pr === '01';
  const powerBadge = `<span class="badge ${powerOn ? 'on':'off'}">${powerOn ? 'On':'Off'}</span>`;
  const sourceText = `Source: ${srcName(zs.ch)}`;
  const volText = `Vol: ${zs.vo ?? '-'}`;
  const muteText = (zs.mu === '01') ? `<span class="muted">• Muted</span>` : '';
  const dndText  = (zs.dt === '01') ? `<span class="dnd">• DND</span>` : '';
  const activeClass = powerOn ? 'active' : '';

  return `
    <div class="tile ${activeClass}" id="tile-${z}">
      <div class="row">
        <strong>${name}</strong>
        <div>${powerBadge} <button onclick="openSettings(${z})">⚙️</button></div>
      </div>
      <div class="small" style="margin-top:6px">
        ${sourceText} • ${volText} ${muteText} ${dndText}
      </div>
      <div class="row" style="margin-top:8px">
        <button class="on" onclick="setPower(${z}, true)">On</button>
        <button class="off" onclick="setPower(${z}, false)">Off</button>
      </div>
      <div style="margin-top:8px">
        <input class="vol" id="vol-${z}" type="range" min="0" max="38" value="${zs.vo ?? 15}"
               oninput="setVolume(${z}, this.value)"/>
      </div>
    </div>`;
}

// --- Load data & render ---
async function render() {
  const live = await getJSON(`${API}/zones`); // includes pr/mu/vo/ch...
  const html = live.map(tileHTML).join('');
  document.getElementById('grid').innerHTML = html;
  document.getElementById('status').textContent = `Last update: ${new Date().toLocaleTimeString()}`;
}

async function load() {
  sources = await getJSON(`${API}/sources`);
  const srcOptions = sources.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
  document.getElementById('s-source').innerHTML = srcOptions;

  const zonePrefs = await getJSON(`${API}/prefs`);
  prefs = {}; zonePrefs.forEach(p => prefs[p.zone] = p);

  await render();

  // Auto refresh (optional)
  if (AUTO_REFRESH_MS > 0) {
    if (refreshTimer) clearInterval(refreshTimer);
    refreshTimer = setInterval(render, AUTO_REFRESH_MS);
  }
}

// --- Actions ---
async function setPower(z, val){ await postJSON(`${API}/zones/${z}/power`, {value: !!val}); await render(); }
async function setVolume(z, v){ await postJSON(`${API}/zones/${z}/volume`, {value: parseInt(v,10)}); }

function openSettings(z){
  currentZone = z;
  const m = document.getElementById('settings'); m.style.display='flex';
  document.getElementById('s-title').textContent = `Zone ${z} settings`;
  document.getElementById('s-name').value = (prefs[z]?.name)||'';
  document.getElementById('s-source').value = (prefs[z]?.default_source)||5; // your common use
  document.getElementById('s-bass').value = (prefs[z]?.default_bass ?? 13);
  document.getElementById('s-treble').value = (prefs[z]?.default_treble ?? 8);
  document.getElementById('s-balance').value = (prefs[z]?.default_balance ?? 7);
}
function closeSettings(){ document.getElementById('settings').style.display='none'; }

document.getElementById('s-save').onclick = async ()=>{
  const name   = document.getElementById('s-name').value;
  const source = parseInt(document.getElementById('s-source').value,10);
  const bass   = parseInt(document.getElementById('s-bass').value,10);
  const treble = parseInt(document.getElementById('s-treble').value,10);
  const balance= parseInt(document.getElementById('s-balance').value,10);

  await postJSON(`${API}/prefs/zone-name`, { zone: currentZone, name });
  await postJSON(`${API}/prefs/defaults`, { zone: currentZone, source, bass, treble, balance });

  // push settings live
  await postJSON(`${API}/zones/${currentZone}/source`, { value: source });
  await postJSON(`${API}/zones/${currentZone}/bass`,   { value: bass });
  await postJSON(`${API}/zones/${currentZone}/treble`, { value: treble });
  await postJSON(`${API}/zones/${currentZone}/balance`,{ value: balance });

  prefs[currentZone] = { zone: currentZone, name, default_source: source, default_bass: bass, default_treble: treble, default_balance: balance };
  closeSettings();
  await render();
};

// --- Source names modal ---
function openSources(){
  const m = document.getElementById('sources'); m.style.display='flex';
  const list = sources.map(s =>
    `<label>Source ${s.id} <input type="text" id="src-${s.id}" value="${s.name}"/></label>`
  ).join('');
  document.getElementById('sources-list').innerHTML = list;
}
function closeSources(){ document.getElementById('sources').style.display='none'; }
async function saveSources(){
  for (const s of sources) {
    const name = document.getElementById(`src-${s.id}`).value;
    await postJSON(`${API}/sources`, { id: s.id, name });
  }
  sources = await getJSON(`${API}/sources`);
  document.getElementById('s-source').innerHTML = sources.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
  closeSources();
  await render();
}

load();
</script>
</body>
</html>

